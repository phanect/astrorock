---
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import type { PageMetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';
import { siteName, metadata } from "~/config.ts";
import config from "../../../astro.config.ts";

export type Props = PageMetaData;

const props = Astro.props;

const canonical = String(getCanonical(String(Astro.url.pathname)));
const searchIndex: boolean = (() => {
  if (!import.meta.env.PROD) {
    return false;
  } else if (typeof props.searchIndex === "boolean") {
    return props.searchIndex;
  } else if (typeof metadata.searchIndex === "boolean") {
    return metadata.searchIndex;
  } else {
    return true;
  }
})();
const ogImage = props.ogImage ?? metadata.ogImage;

const seoProps: AstroSeoProps = {
  title: props.ignoreTitleTemplate ? props.title : metadata.titleTemplate(props.title),
  description: props.description ?? metadata.description,
  canonical: canonical,
  noindex: !searchIndex,
  nofollow: !searchIndex,
  openGraph: {
    url: canonical,
    site_name: siteName,
    images: ogImage ? [ ogImage ] : undefined,
    locale: config.i18n?.defaultLocale ?? 'en',
    type: 'website',
  },
  twitter: {
    handle: metadata.twitter?.creator,
    cardType: (props.ogImage ?? metadata.ogImage) ? "summary_large_image" : "summary",
    ...metadata.twitter,
  },
};
---

<AstroSeo {...seoProps } />
